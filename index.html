<!DOCTYPE html>
<html lang="en">
  <head>
    <script>
      function getCookie(name) {
        var v = document.cookie.match("(^|;) ?" + name + "=([^;]*)(;|$)");
        return v ? v[2] : null;
      }
      if (!getCookie("user-token")) {
        window.location.href = "login.html";
      }
    </script>
    <meta charset="UTF-8" />
    <link
      rel="shortcut icon"
      href="assets/img/icon192x192.png"
      type="image/x-icon"
    />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Kasir MA</title>
    <link rel="manifest" href="web.webmanifest" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="assets/css/bootstrap.min.css" />
    <link rel="stylesheet" href="assets/font/bootstrap-icons.min.css" />
    <link rel="stylesheet" href="assets/css/style.css" />
    <link rel="stylesheet" href="assets/css/sweetalert2.min.css" />
  </head>

  <body>
    <div class="progress progress-striped rounded-0 active">
      <div class="progress-bar progress-bar-success" style="width: 0%"></div>
    </div>
    <!-- Fixed sidebar -->
    <div
      class="d-flex flex-column flex-shrink-0 bg-body-tertiary sidenav"
      style="width: 4.5rem"
    >
      <ul class="nav nav-pills nav-flush flex-column mb-auto text-center">
        <li class="nav-item">
          <a
            href="index.html"
            class="btn btn-outline-dark active py-3 border-bottom ps-1 rounded-0 fs-4"
            aria-current="page"
            title="Home"
            data-bs-toggle="tooltip"
            data-bs-placement="right"
          >
            <i class="bi-grid"></i>
          </a>
        </li>
        <li class="nav-item">
          <a
            href="nota.html"
            class="btn btn-outline-dark border-0 py-3 border-bottom ps-1 rounded-0 fs-4"
            aria-current="page"
            title="Home"
            data-bs-toggle="tooltip"
            data-bs-placement="right"
          >
            <i class="bi-receipt"></i>
          </a>
        </li>
        <li class="nav-item">
          <a
            href="laporan.html"
            class="btn btn-outline-dark border-0 py-3 border-bottom ps-1 rounded-0 fs-4"
            aria-current="page"
            title="Home"
            data-bs-toggle="tooltip"
            data-bs-placement="right"
          >
            <i class="bi-printer"></i>
          </a>
        </li>
      </ul>
      <div>
        <a
          id="btn-menu-mobile"
          class="nav-link px-4 py-2 fs-3"
          data-bs-toggle="offcanvas"
          href="#offcanvasExample"
          role="button"
          aria-controls="offcanvasExample"
        >
          <i class="bi-justify"></i>
        </a>
      </div>
    </div>

    <!-- Input Scan -->
    <input
      type="text"
      id="input-scan"
      style="position: absolute; z-index: 100; opacity: 0"
    />

    <!-- ./Fixed sidebar -->
    <div class="container-fluid vh-100">
      <div class="main row h-100">
        <div class="col col-md-7 h-100 px-0">
          <div class="card h-100">
            <div class="row mb-1">
              <div class="col col-md-12">
                <div class="input-group">
                  <input
                    type="text"
                    id="search_box"
                    class="form-control fs-5"
                    placeholder="Cari..."
                    aria-describedby="basic-addon2"
                  />
                  <span class="input-group-text" id="basic-addon2">
                    <i class="bi-search"></i>
                  </span>
                </div>
              </div>
            </div>
            <div class="btn-group rounded-0">
              <button
                type="button"
                data-id="favorite"
                data-nama="Favorite"
                class="btn-categories btn btn-outline-dark rounded-0 active"
                data-bs-toggle="button"
              >
                <i class="bi bi-star-fill"></i>
              </button>
              <button
                type="button"
                data-id=""
                data-nama="Semua Produk"
                class="btn-categories btn btn-outline-dark rounded-0"
                id="all-categories"
                data-bs-toggle="button"
              >
                Semua
              </button>
              <button
                type="button"
                data-id="null"
                data-nama="Uncategorized"
                class="btn-categories btn btn-outline-dark rounded-0"
                data-bs-toggle="button"
              >
                Uncategorized
              </button>
            </div>
            <span
              class="text-center fw-semibold mt-1"
              id="title-product"
            ></span>
            <div class="overflow-y-auto px-2 pb-2">
              <table class="table table-hover">
                <tbody id="table-products"></tbody>
              </table>
              <div id="favorite">
                <div class="overflow-y-auto px-2 pb-2" style="height: 80vh">
                  <div
                    class="row row-cols-3 row-cols-lg-4 g-2 g-lg-2 gy-lg-2"
                    id="table-products"
                  >
                    <div class="col">
                      <div
                        class="hover-button p-2 py-3 border rounded text-center"
                        style="cursor: pointer; min-height: 100px"
                      >
                        <div class="fs-3 fw-semibold text-secondary py-2">
                          <i class="bi bi-plus-circle"></i>
                        </div>
                        <p style="font-size: 11px; line-height: 100%">
                          Add Item
                        </p>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Right panel / cart / keranjang -->
        <div class="col col-md-5 h-100">
          <div class="card h-100">
            <div class="card-header p-0">
              <div
                class="btn-group d-flex"
                role="group"
                aria-label="Basic example"
                style="height: 60px"
              >
                <button
                  type="button"
                  class="btn w-25 btn-outline-secondary rounded-bottom-0"
                  id="btn-list-bill"
                >
                  <i class="bi-receipt d-block fs-5" style="height: 16px"></i>
                  <small clas>Daftar Bill</small>
                </button>
                <button
                  type="button"
                  id="customer-name"
                  class="btn w-100 btn-outline-secondary fs-5 rounded-bottom-0"
                >
                  + Tambah Pelanggan
                </button>
              </div>
            </div>
            <div class="card-body overflow-auto px-2">
              <table class="table table-sm table-hover" style="font-size: 14px">
                <tbody id="cart-active"></tbody>
              </table>
            </div>
            <div class="card-footer p-0 bg-dark-subtle">
              <div
                class="btn-group d-flex"
                role="group"
                aria-label="Basic example"
                style="height: 50px"
              >
                <button
                  type="button"
                  class="btn w-25 btn-outline-dark rounded-0 border-bottom-0"
                  id="btn-save"
                >
                  <i class="bi-floppy"></i>
                  Simpan
                </button>
                <button
                  type="button"
                  class="btn w-25 btn-outline-dark rounded-0 border-bottom-0"
                  id="btn-print-bill"
                >
                  <i class="bi-printer"></i>
                  Cetak
                </button>
              </div>
            </div>
            <div class="card-footer p-0">
              <div
                class="btn-group d-flex"
                role="group"
                aria-label="Basic example"
                style="height: 70px"
              >
                <button
                  type="button"
                  class="btn w-25 btn-outline-dark rounded-top-0"
                  id="btn-modal-split-bill"
                >
                  <i
                    class="bi-receipt-cutoff d-block fs-5"
                    style="height: 16px"
                  ></i>
                  <small clas>Pisah Bill</small>
                </button>
                <button
                  type="button"
                  class="btn w-100 btn-dark fs-4 rounded-top-0"
                  id="btn-payment"
                >
                  Bayar : <b id="payment"></b>
                </button>
              </div>
            </div>
          </div>
        </div>
        <!-- ./Right panel / cart / keranjang -->
      </div>
    </div>

    <!-- Sidebar off canvas -->
    <div
      class="sidebar-mobile offcanvas offcanvas-start"
      tabindex="-1"
      id="offcanvasExample"
      style="width: 280px"
      aria-labelledby="offcanvasExampleLabel"
    >
      <div class="offcanvas-header">
        <h5 class="offcanvas-title" id="offcanvasExampleLabel">KASIR MA</h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="offcanvas"
          aria-label="Close"
        ></button>
      </div>
      <div class="offcanvas-body sidebar-body">
        <div class="img-profile">
          <div class="avatar-profile">
            <img
              class="rounded-circle"
              src="https://picsum.photos/128"
              width="64px"
            />
          </div>
          <p class="mb-0 mt-3">Username</p>
        </div>
        <nav class="mt-3">
          <ul class="nav nav-pills flex-column">
            <li class="nav-item">
              <button
                type="button"
                class="link-dark p-3 w-100 text-start btn btn-outline-secondary"
                id="btn-logout"
              >
                <i class="bi-box-arrow-right me-2"></i>Logout
              </button>
            </li>
          </ul>
        </nav>
      </div>
    </div>
    <!-- ./Sidebar off canvas -->

    <!-- Modal Click Produk Varian -->
    <div id="ModalVarian"></div>

    <!-- Modal tambah pelanggan -->
    <div id="ModalPelanggan"></div>

    <!-- Modal Bayar -->
    <div id="ModalBayar"></div>

    <!-- Modal transaksi berhasil -->
    <div id="ModalTransaksiBerhasil"></div>

    <!-- Modal Simpan Bill -->
    <div id="ModalSimpanBill"></div>

    <!-- Modal List Bill -->
    <div id="ModalListBill"></div>

    <!-- Modal alert -->
    <div id="ModalAlert"></div>

    <!-- Modal Pisah Bill -->
    <div id="ModalPisahBill"></div>

    <!-- Register PWA -->
    <script src="register.js"></script>
    <!-- Config -->
    <script src="assets/js/config.js"></script>
    <script src="assets/js/jquery.min.js"></script>
    <!-- Load modal -->
    <script>
      $("#ModalVarian").load("component/ModalVarian.html");
      $("#ModalPelanggan").load("component/ModalPelanggan.html");
      $("#ModalBayar").load("component/ModalBayar.html");
      $("#ModalTransaksiBerhasil").load(
        "component/ModalTransaksiBerhasil.html"
      );
      $("#ModalSimpanBill").load("component/ModalSimpanBill.html");
      $("#ModalListBill").load("component/ModalListBill.html");
      $("#ModalAlert").load("component/ModalAlert.html");
      $("#ModalPisahBill").load("component/ModalPisahBill.html");
    </script>
    <!-- Load JS -->
    <script src="assets/js/loadingoverlay.min.js"></script>
    <script src="assets/js/sweetalert2.all.min.js"></script>
    <script src="assets/js/js.cookie.min.js"></script>
    <script src="assets/js/bootstrap.bundle.min.js"></script>
    <script src="assets/js/moment.min.js"></script>
    <script src="assets/js/moment-with-locales.min.js"></script>
    <script src="assets/js/moment-timezone-with-data.js"></script>
    <script src="assets/js/func/index.js"></script>
    <script src="assets/js/func/AjaxProduk.js"></script>
    <script src="assets/js/func/AjaxCart.js"></script>
    <script src="assets/js/func/AjaxBill.js"></script>
    <script src="assets/js/func/ScanBarcode.js"></script>
    <script>
      // Print Transaksi Berhasil
      $(document).ready(function () {
        $(document).on("click", "#print-nota-transaksi", function () {
          let printTransaksi = {
            store: "// UD MURTI AJI ////",
            address:
              "Jl. Karang Kencana No.51, Panjunan, Kec. Lemahwungkuk, Kota Cirebon, Jawa Barat 45112",
            phone: "Telp/WA 0853 1457 9001",
            date: "",
            name: "",
            no_nota: "",
            items: [],
            total: 0,
            payment_method: "",
            payment: "",
            change: 0,
          };

          const id = localStorage.getItem("idTransaksi")
            ? localStorage.getItem("idTransaksi")
            : "";
          const URL = config.ENV_URL + "/transactions/" + id;

          $.ajax({
            url: URL,
            method: "GET",
            headers: {
              Authorization: Cookies.get("user-token"),
            },
            success: function (data) {
              const datas = data.data;
              console.log(datas);

              printTransaksi.date = "";
              printTransaksi.name = "";
              printTransaksi.no_nota = "";
              printTransaksi.items = [];
              printTransaksi.total = 0;
              printTransaksi.payment_method = "";
              printTransaksi.payment = "";
              printTransaksi.change = 0;

              datas.details.forEach((item, index) => {
                printTransaksi.items.push({
                  price: item.price,
                  productName: item.productName,
                  qty: item.qty,
                  subtotal: item.subtotal,
                  variantName: item.variantName,
                });
              });

              printTransaksi.date = moment(datas.date)
                .tz("Asia/Jakarta")
                .format("DD/MM/YYYY HH:mm");
              printTransaksi.name = datas.customer.name;
              printTransaksi.no_nota = datas.receipt_no;
              printTransaksi.total = datas.total_amount;
              printTransaksi.payment_method =
                datas.payment_method.toString().charAt(0).toUpperCase() +
                datas.payment_method.slice(1);
              printTransaksi.payment = datas.payment_amount;
              printTransaksi.change = datas.change_amount;

              let struk = [];

              struk.push(printTransaksi.store);
              struk.push(printTransaksi.address);
              struk.push(printTransaksi.phone);
              struk.push("--------------------------------");
              struk.push("Nama: " + printTransaksi.name);
              struk.push("Order ID: " + printTransaksi.no_nota);
              struk.push("Tanggal: " + printTransaksi.date);
              struk.push("--------------------------------");

              printTransaksi.items.forEach((item) => {
                struk.push(item.productName); // nama produk

                // varian (jika berbeda)
                if (item.variantName && item.variantName !== item.productName) {
                  struk.push(" # " + item.variantName);
                }

                // harga satuan dan subtotal
                let line = ` x${item.qty} @${item.price}`;
                struk.push(line + `${item.subtotal}`.padStart(18));
              });

              struk.push("--------------------------------");
              struk.push("Total                  " + printTransaksi.total);
              struk.push("Bayar                  " + printTransaksi.payment);
              struk.push(printTransaksi.payment_method);
              struk.push("Kembalian              " + printTransaksi.change);
              struk.push("--------------------------------");
              struk.push("Terima kasih");

              let escPosData = encodeURIComponent(struk.join("\n"));
              window.location.href = "rawbt://" + escPosData;
            },
          });
        });
      });
    </script>
  </body>
</html>
